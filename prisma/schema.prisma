generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String           @id @default(cuid())
  email            String           @unique
  password         String
  role             String           @default("user")
  resetToken       String?
  resetTokenExpiry DateTime?
  preferences      Json?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  providerConfigs  ProviderConfig[]
  novels           Novel[]

  @@index([resetToken])
}

model ProviderConfig {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  providerType    String
  baseURL         String
  apiKeyCiphertext String
  defaultModel    String?
  models          Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model Novel {
  id              String          @id @default(cuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  title           String
  description     String?         @db.Text
  type            String          @default("short") // "short" or "long"
  goldenFinger    String?         @db.Text
  generationStage String          @default("seed") // seed, seeded, rough, detailed, chapters, drafting, completed
  outline         String?         @db.Text
  outlineRough    Json?
  outlineDetailed Json?
  outlineChapters Json?
  outlineStage    String          @default("none") // none, rough, detailed, chapters
  wizardStatus    String          @default("draft") // draft, in_progress, completed
  wizardStep      Int             @default(0)
  outlineMode     String          @default("simple")
  theme           String?
  genre           String?
  targetWords     Int?
  chapterCount    Int?
  protagonist     String?         @db.Text
  worldSetting    String?         @db.Text
  worldTimePeriod String?
  worldLocation   String?
  worldAtmosphere String?
  worldRules      String?         @db.Text
  keywords        String[]        @default([])
  specialRequirements String?     @db.Text
  inspirationData Json?
  // 工作流配置
  workflowConfig        Json?               // 工作流配置 (审查阈值等)
  hookReminderChapters  Int       @default(10)  // 钩子提醒阈值 (N章后提醒)
  outlineDeviationLimit Float     @default(0.4) // 大纲偏离上限 (40%)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  chapters        Chapter[]
  materials       Material[]
  lorebookEntries LorebookEntry[]
  narrativeHooks  NarrativeHook[]
  pendingEntities PendingEntity[]
  actSummaries    ActSummary[]
  chapterSummaries ChapterSummary[]

  @@index([userId])
}

model Chapter {
  id               String           @id @default(cuid())
  novelId          String
  novel            Novel            @relation(fields: [novelId], references: [id], onDelete: Cascade)
  title            String
  order            Int
  content          String           @db.Text
  currentVersionId String?
  generationStage  String           @default("draft") // draft, generating, generated, reviewing, reviewed, approved, rejected, humanizing, humanized, completed
  reviewIterations Int              @default(0)
  // 新增审查相关字段
  reviewFeedback   Json?            // 结构化审查反馈
  outlineAdherence Float?           // 大纲符合度分数 (0-1)
  pendingReview    Boolean          @default(false) // 是否等待批量审查
  approvedAt       DateTime?        // 审查通过时间
  lastReviewAt     DateTime?        // 最后审查时间
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  versions         ChapterVersion[]
  summary          ChapterSummary?

  @@unique([novelId, order])
  @@index([novelId])
  @@index([novelId, generationStage])
  @@index([novelId, pendingReview])
}

model ChapterVersion {
  id              String   @id @default(cuid())
  chapterId       String
  chapter         Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  content         String   @db.Text
  isBranch        Boolean  @default(false)
  branchNumber    Int?
  parentVersionId String?
  createdAt       DateTime @default(now())

  @@index([chapterId])
  @@index([chapterId, isBranch])
}

model LorebookEntry {
  id                String   @id @default(cuid())
  novelId           String
  novel             Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  keys              String[]
  content           String   @db.Text
  priority          Int      @default(50)
  isEnabled         Boolean  @default(true)
  insertionPosition String   @default("before")
  activationRules   Json?
  category          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([novelId])
  @@index([novelId, isEnabled])
}

model Material {
  id          String   @id @default(cuid())
  novelId     String
  novel       Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  userId      String
  type        String
  name        String
  genre       String   @default("通用")
  searchGroup String?
  sourceUrl   String?
  data        Json
  aliases     String[] @default([])
  lastActiveChapter Int?
  appearanceCount   Int      @default(0)
  codexPriority     Int      @default(50)
  codexMetadata     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([novelId])
  @@index([userId])
  @@index([type])
  @@index([genre])
  @@index([searchGroup])
  @@index([novelId, lastActiveChapter])
}

model PromptTemplate {
  id        String   @id @default(cuid())
  userId    String
  name      String
  content   String   @db.Text
  variables Json?
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model AgentDefinition {
  id               String   @id @default(cuid())
  userId           String
  name             String
  description      String?
  category         String?  // "writing", "review", "utility"
  templateId       String?
  providerConfigId String?
  model            String?
  params           Json?
  isBuiltIn        Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
}

model MemorySnapshot {
  id        String   @id @default(cuid())
  chapterId String
  novelId   String
  data      Json
  createdAt DateTime @default(now())

  @@index([chapterId])
  @@index([novelId])
}

model JobChunk {
  id        String   @id @default(cuid())
  jobId     String
  seq       Int
  kind      String
  payload   Json
  createdAt DateTime @default(now())

  @@index([jobId, seq])
}

model UsageRecord {
  id               String   @id @default(cuid())
  userId           String
  jobId            String?
  provider         String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCost    Float?
  createdAt        DateTime @default(now())

  @@unique([jobId, provider, model])
  @@index([userId])
  @@index([jobId])
}

model ModelPrice {
  id                    String   @id @default(cuid())
  provider              String
  model                 String
  promptTokenPrice      Float
  completionTokenPrice  Float
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([provider, model])
}

model Job {
  id           String   @id @default(cuid())
  userId       String
  type         String
  status       String   @default("queued")
  input        Json?
  output       Json?
  error        String?
  attemptCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

model FileObject {
  id        String   @id @default(cuid())
  userId    String
  novelId   String?
  filename  String
  mimeType  String
  size      Int
  path      String
  sha256    String
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([novelId])
}

model AuditEvent {
  id          String   @id @default(cuid())
  userId      String?
  action      String
  resource    String
  resourceId  String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  success     Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model ArticleAnalysis {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   String   @db.Text
  genre     String?
  analysis  Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt(sort: Desc)])
}

model AnalysisTemplate {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  aspects     Json
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model RateLimit {
  key       String   @id
  count     Int      @default(1)
  resetTime DateTime

  @@index([resetTime])
}

// ═══════════════════════════════════════════════════════════════
// 叙事钩子追踪 - 管理伏笔、悬念、契诃夫之枪等叙事元素
// ═══════════════════════════════════════════════════════════════
model NarrativeHook {
  id                   String   @id @default(cuid())
  novelId              String
  novel                Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  type                 String   // foreshadowing, chekhov_gun, mystery, promise, setup
  description          String   @db.Text
  plantedInChapter     Int
  plantedContext       String?  @db.Text  // 埋设时的具体文本
  referencedInChapters Int[]    @default([])
  resolvedInChapter    Int?
  resolutionContext    String?  @db.Text  // 解决时的具体文本
  status               String   @default("planted") // planted, referenced, resolved, abandoned
  importance           String   @default("minor")   // critical, major, minor
  expectedResolutionBy Int?     // 预期解决章节
  reminderThreshold    Int      @default(10)        // N章后提醒
  relatedCharacters    String[] @default([])
  relatedOrganizations String[] @default([])
  notes                String?  @db.Text
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([novelId])
  @@index([novelId, status])
  @@index([status, plantedInChapter])
}

// ═══════════════════════════════════════════════════════════════
// 章节摘要 - 用于长篇小说上下文压缩
// ═══════════════════════════════════════════════════════════════
model ChapterSummary {
  id                    String   @id @default(cuid())
  chapterId             String   @unique
  chapter               Chapter  @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  novelId               String
  novel                 Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  chapterNumber         Int
  oneLine               String   @db.Text
  keyEvents             Json     @default("[]")
  characterDevelopments Json     @default("[]")
  plotAdvancement       String?  @db.Text
  emotionalArc          String?
  newCharacters         Json     @default("[]")
  newOrganizations      Json     @default("[]")
  hooksPlanted          Json     @default("[]")
  hooksReferenced       Json     @default("[]")
  hooksResolved         Json     @default("[]")
  sceneBreakdown        Json?
  actNumber             Int?
  actSummaryId          String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([novelId])
  @@index([novelId, chapterNumber])
  @@index([novelId, actNumber])
}

model ActSummary {
  id                  String   @id @default(cuid())
  novelId             String
  novel               Novel    @relation(fields: [novelId], references: [id], onDelete: Cascade)
  actNumber           Int
  title               String?
  chapterRange        Json
  oneLine             String   @db.Text
  majorEvents         Json     @default("[]")
  characterArcs       Json     @default("[]")
  plotProgression     String?  @db.Text
  thematicElements    Json     @default("[]")
  unresolvedHooks     Json     @default("[]")
  resolvedHooks       Json     @default("[]")
  tensionLevel        Int?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([novelId, actNumber])
  @@index([novelId])
}

// ═══════════════════════════════════════════════════════════════
// 待确认实体队列 - 管理章节中涌现的新角色/组织
// ═══════════════════════════════════════════════════════════════
model PendingEntity {
  id             String    @id @default(cuid())
  novelId        String
  novel          Novel     @relation(fields: [novelId], references: [id], onDelete: Cascade)
  chapterId      String
  chapterNumber  Int
  entityType     String    // character, organization
  name           String
  extractedData  Json      // 从章节提取的原始数据
  status         String    @default("pending") // pending, approved, rejected, merged
  mergedWithId   String?   // 如果与已有实体合并,记录目标Material ID
  reviewNotes    String?   @db.Text
  reviewedAt     DateTime?
  createdAt      DateTime  @default(now())

  @@index([novelId, status])
  @@index([chapterId])
  @@index([novelId, entityType, status])
}
